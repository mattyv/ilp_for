name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    name: ${{ matrix.config.os }}-${{ matrix.config.compiler }}-${{ matrix.ilp_mode }}
    runs-on: ${{ matrix.config.os }}

    strategy:
      fail-fast: false
      matrix:
        ilp_mode: [ILP, SIMPLE]
        config:
          - { os: ubuntu-24.04, compiler: gcc-13, cc: gcc-13, cxx: g++-13 }
          - { os: ubuntu-24.04, compiler: gcc-14, cc: gcc-14, cxx: g++-14 }
          - { os: ubuntu-24.04, compiler: clang-18, cc: clang-18, cxx: clang++-18 }
          - { os: macos-14, compiler: appleclang, cc: clang, cxx: clang++ }
          - { os: macos-14, compiler: gcc-14, cc: gcc-14, cxx: g++-14 }
          - { os: windows-latest, compiler: msvc, cc: cl, cxx: cl }
          - { os: windows-latest, compiler: clang, cc: clang-cl, cxx: clang-cl }

    steps:
      - uses: actions/checkout@v4

      - name: Install GCC (Linux)
        if: runner.os == 'Linux' && startsWith(matrix.config.compiler, 'gcc')
        run: |
          sudo apt-get update
          sudo apt-get install -y ${{ matrix.config.cxx }}

      - name: Install Clang (Linux)
        if: runner.os == 'Linux' && startsWith(matrix.config.compiler, 'clang')
        run: |
          sudo apt-get update
          sudo apt-get install -y ${{ matrix.config.compiler }}

      - name: Install GCC (macOS)
        if: runner.os == 'macOS' && startsWith(matrix.config.compiler, 'gcc')
        run: |
          brew install gcc@14

      - name: Setup MSVC (Windows)
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install Clang (Windows)
        if: runner.os == 'Windows' && matrix.config.compiler == 'clang'
        run: |
          choco install llvm --version=18.1.8 -y
          echo "C:\Program Files\LLVM\bin" >> $env:GITHUB_PATH

      - name: Set ILP mode flags
        id: ilp_flags
        shell: bash
        run: |
          if [ "${{ matrix.ilp_mode }}" = "SIMPLE" ]; then
            echo "cxx_flags=-DILP_MODE_SIMPLE" >> $GITHUB_OUTPUT
          else
            echo "cxx_flags=" >> $GITHUB_OUTPUT
          fi

      - name: Configure (Unix)
        if: runner.os != 'Windows'
        run: |
          mkdir -p tests/build
          cd tests/build
          cmake .. -DCMAKE_C_COMPILER=${{ matrix.config.cc }} -DCMAKE_CXX_COMPILER=${{ matrix.config.cxx }} -DCMAKE_CXX_STANDARD=23 -DCMAKE_CXX_FLAGS="${{ steps.ilp_flags.outputs.cxx_flags }}"
        env:
          CC: ${{ matrix.config.cc }}
          CXX: ${{ matrix.config.cxx }}

      - name: Configure (Windows)
        if: runner.os == 'Windows'
        run: |
          mkdir tests\build
          cd tests\build
          cmake .. -G "NMake Makefiles" -DCMAKE_C_COMPILER=${{ matrix.config.cc }} -DCMAKE_CXX_COMPILER=${{ matrix.config.cxx }} -DCMAKE_CXX_STANDARD=23 -DCMAKE_CXX_FLAGS="${{ steps.ilp_flags.outputs.cxx_flags }}"

      - name: Build (Unix)
        if: runner.os != 'Windows'
        run: |
          cd tests/build
          make test_runner

      - name: Build (Windows)
        if: runner.os == 'Windows'
        run: |
          cd tests\build
          nmake test_runner

      - name: Run Tests (Unix)
        if: runner.os != 'Windows'
        run: |
          cd tests/build
          ./test_runner

      - name: Run Tests (Windows)
        if: runner.os == 'Windows'
        run: |
          cd tests\build
          .\test_runner.exe

  tuner-tests:
    name: tuner-js-tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run Tuner Tests
        run: node docs/tuner/tuner-tests.js

  sanitizers:
    name: sanitizers-${{ matrix.sanitizer }}
    runs-on: ubuntu-24.04

    strategy:
      fail-fast: false
      matrix:
        sanitizer: [asan, ubsan]

    steps:
      - uses: actions/checkout@v4

      - name: Install Clang
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-18

      - name: Configure
        run: |
          mkdir -p tests/build
          cd tests/build
          if [ "${{ matrix.sanitizer }}" = "asan" ]; then
            cmake .. -DCMAKE_C_COMPILER=clang-18 -DCMAKE_CXX_COMPILER=clang++-18 -DCMAKE_CXX_STANDARD=23 -DENABLE_ASAN=ON
          else
            cmake .. -DCMAKE_C_COMPILER=clang-18 -DCMAKE_CXX_COMPILER=clang++-18 -DCMAKE_CXX_STANDARD=23 -DENABLE_UBSAN=ON
          fi

      - name: Build
        run: |
          cd tests/build
          make test_runner

      - name: Run Tests
        run: |
          cd tests/build
          if [ "${{ matrix.sanitizer }}" = "ubsan" ]; then
            ./test_runner '~[overflow]'
          else
            ./test_runner
          fi

  clang-tidy-check:
    name: clang-tidy-check
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@v4

      - name: Install LLVM/Clang
        run: |
          sudo apt-get update
          sudo apt-get install -y llvm-18-dev libclang-18-dev clang-18 clang-tidy-18

      - name: Configure clang-tidy module
        run: |
          cd tools/clang-tidy
          cmake -B build \
            -DCMAKE_CXX_COMPILER=clang++-18 \
            -DLLVM_DIR=/usr/lib/llvm-18/lib/cmake/llvm \
            -DClang_DIR=/usr/lib/llvm-18/lib/cmake/clang

      - name: Build clang-tidy module
        run: |
          cd tools/clang-tidy
          cmake --build build

      - name: Test clang-tidy module
        run: |
          cd tools/clang-tidy
          clang-tidy-18 \
            -load build/ILPTidyModule.so \
            -checks='-*,ilp-*' \
            test/loop_patterns.cpp \
            -- -std=c++20 -I../.. 2>&1 | tee output.txt
          # Verify expected patterns are detected
          grep -q "Sum pattern" output.txt
          grep -q "DotProduct pattern" output.txt
          grep -q "Search pattern" output.txt
          grep -q "Copy pattern" output.txt
          grep -q "Multiply pattern" output.txt
          grep -q "Divide pattern" output.txt
          grep -q "Bitwise pattern" output.txt
          grep -q "Shift pattern" output.txt
          echo "All expected patterns detected!"
